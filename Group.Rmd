---
title: "Group"
output: 
  bookdown::html_document2
echo: FALSE
---

```{r, inlude=FALSE}
library(tidyverse)
library(visdat)
library(pheatmap)
library(broom)
library(ggrepel)
```

# Introduction
```{r}
# Load the data
stock <- read_csv("Data/SampleA.csv")
market <- read_csv("Data/Market.csv")
```

# IDA and EDA
### Check missing values and data types
```{r}
vis_miss(stock) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
vis_dat(stock) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

```{r}
# Transform to Date format
stock <- stock %>%
  mutate(
    year = str_extract(Date, "\\d{4}"),
    month = str_extract(Date, "(?<=M)\\d+"),
    month = str_pad(month, width = 2, pad = "0"),
    Date = paste0(year, "-", month),
    Date = as.Date(paste0(Date, "-01"))
  ) %>%
  select(-year, -month)

market <- market %>%
  mutate(
    year = str_extract(Date, "\\d{4}"),
    month = str_extract(Date, "(?<=M)\\d+"),
    month = str_pad(month, width = 2, pad = "0"),
    Date = paste0(year, "-", month),
    Date = as.Date(paste0(Date, "-01"))
  ) %>%
  select(-year, -month)
```

### Check for outliers using z-scores 

```{r}
# Compute z-scores for each stock
stock_z <- stock %>%
  mutate(across(-Date, ~ scale(.)[, 1], .names = "{.col}_z"))

stock_z_long <- stock_z %>%
  pivot_longer(
    cols = ends_with("_z"),
    names_to = "Stock_z",
    values_to = "Z_Score"
  ) %>%
  mutate(
    Stock = str_remove(Stock_z, "_z") 
  )

# Filter rows where abs(z-score) > 3 (3-sigma outliers)
outlier_df <- stock_z_long %>%
  filter(abs(Z_Score) > 3) %>%
  select(Date, Stock, Z_Score) %>%
  arrange(desc(abs(Z_Score)))

# join with raw returns
outlier_df <- outlier_df %>%
  left_join(stock %>% 
              pivot_longer(-Date, names_to = "Stock", values_to = "Return"),
            by = c("Date", "Stock"))

# View as tibble
top_outlier <- head(outlier_df,5)
```

```{r}
# Per-stock summary stats
long <- stock %>% 
  pivot_longer(-Date, names_to = "stock", values_to = "ret")
summ <- long %>%
  group_by(stock) %>%
  summarise(
    n = sum(!is.na(ret)),
    miss_rate = mean(is.na(ret)),
    mean = mean(ret, na.rm = TRUE),
    sd = sd(ret, na.rm = TRUE),
    min = min(ret, na.rm = TRUE),
    p25 = quantile(ret, 0.25, na.rm = TRUE),
    median = median(ret, na.rm = TRUE),
    p75 = quantile(ret, 0.75, na.rm = TRUE),
    max = max(ret, na.rm = TRUE),
    .groups = "drop"
  ) %>% arrange(desc(sd))
summ %>% slice_head(n = 12)
```

### Boxplot of top volatile stocks
```{r}
top9 <- summ %>% slice_max(sd, n = pmin(9, nrow(summ))) %>% pull(stock)
stock %>%
  select(Date, all_of(top9)) %>%
  pivot_longer(-Date, names_to = "stock", values_to = "ret") %>%
  ggplot(aes(stock, ret)) +
  geom_boxplot(outlier.alpha = 0.5) +
  coord_flip() +
  labs(title = "Return distributions — top9 volatile stock", x = NULL, y = "Monthly return") +
  theme_minimal()
```

### Time series of top volatile stocks
```{r}
stock %>%
  select(Date, all_of(top9)) %>%
  pivot_longer(-Date, names_to = "stock", values_to = "ret") %>%
  ggplot(aes(Date, ret)) +
  geom_line(linewidth = 0.3) +
  facet_wrap(~ stock, scales = "free_y") +
  labs(title = "Monthly returns over time — top9 volatile stock", x = NULL, y = "Return") +
  theme_minimal()
```

### Check duplicates
```{r}
#Check duplicate value
stock %>% filter(duplicated(.))
```

### Check for missing months
```{r}
# Check for missing months
seq_months <- tibble(Date = seq(min(stock$Date, na.rm = TRUE),
                                max(stock$Date, na.rm = TRUE),
                                by = "month"))
missing_months <- seq_months %>% 
  anti_join(stock %>% distinct(Date), by = "Date")
```

### Industry summary

```{r, tbl.cap="Industry summary statistics"}}

# Extract industry from stock names
stock_ind <- long %>%
  mutate(ind = str_extract(stock, "^[A-Za-z]+"))

ind_summary <- stock_ind %>%
  group_by(ind) %>%
  summarise(
    n_stocks = n_distinct(stock),
    mean_ret = mean(ret, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange()

knitr::kable(ind_summary)
```

H is the largest industry while B and G are the smallest. Industry D has the highest mean return, while industry G has the lowest.  

```{r, fig.cap="Stock Price Movement by industry"}

# Industry movement
ind_move <- stock_ind %>% 
  group_by(Date, ind) %>%
  summarise(mean_ret = mean(ret))

# Time series
ggplot(ind_move, aes(x = Date)) +
  geom_line(aes(y = mean_ret), color = "black") +
  facet_wrap(~ind) +
  theme_minimal() +
  labs(
    title = "Industry mean returns over time",
    x = "Date",
    y = "Return") +
  theme(legend.position = "bottom")

```

Industry B, D, and E have more fluctuations, while industry F and H are more stable.  

## Industry-level correlation matrix with the market return
```{r cor, tbl.cap="Correlation between industry mean returns and market return"}
ind_wide <- ind_move %>% 
  left_join(market) %>% 
  select(Date, ind, mean_ret, MarketReturn) %>%
  pivot_wider(names_from = ind, values_from = mean_ret)

ind_wide_num <- ind_wide %>%
  mutate(across(where(is.character), as.numeric)) %>% 
  as.data.frame() %>%
  select(-Date)

# Compute correlation
cor_mat <- cor(ind_wide_num, use = "pairwise.complete.obs")

# Turn into table
cor_tbl <- as.data.frame(round(cor_mat, 3))

knitr::kable(cor_tbl)
```

```{r}
# Order rows/cols by their correlation with MarketReturn (descending)
ord <- order(mat[, "MarketReturn"], decreasing = TRUE)
mat_ord <- mat[ord, ord]

pheatmap::pheatmap(
  mat_ord,
  color = pal,
  breaks = brks,
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  display_numbers = TRUE,
  number_format = "%.2f",
  legend = TRUE,
  fontsize_number = 8,
  main = "Correlation Heatmap (ordered by MarketReturn alignment)"
)

```

Industry-level correlations reveal that Services (I), Finance (H), and Transportation/Utilities (E) are most closely aligned with the market return (correlations of 0.888, 0.880, and 0.819, respectively). This suggests that these sectors carry the greatest degree of systematic risk, moving strongly with overall market fluctuations. By contrast, Retail Trade (G) has the lowest correlation with the market (0.578), indicating that returns in this sector are more idiosyncratic and less influenced by broad market factors. Industries B, D, and F fall in between, reflecting moderate exposure to systematic risk.

```{r}
# Add industry label
stock_mkt_cor2 <- stock_mkt_cor %>%
  mutate(industry = substr(stock, 1, 1))

# Top / bottom 10 by signed correlation
knitr::kable(head(stock_mkt_cor2, 10), caption = "Top 10 stocks most positively correlated with Market")
knitr::kable(tail(stock_mkt_cor2, 10), caption = "Bottom 10 stocks (least / negative correlation)")

# Top 10 positive
stock_mkt_cor2 %>%
  slice_max(cor_with_market, n = 10) %>%
  ggplot(aes(x = reorder(stock, cor_with_market), y = cor_with_market, fill = industry)) +
  geom_col() +
  coord_flip() +
  labs(title = "Top 15 stocks most positively correlated with Market",
       x = NULL, y = "Correlation with Market") +
  theme_minimal()

# Bottom 10 
stock_mkt_cor2 %>%
  slice_min(cor_with_market, n = 10) %>%
  ggplot(aes(x = reorder(stock, cor_with_market), y = cor_with_market, fill = industry)) +
  geom_col() +
  coord_flip() +
  labs(title = "Bottom 15 stocks (least / negatively correlated with Market)",
       x = NULL, y = "Correlation with Market") +
  theme_minimal()

```
The top 10 stocks most correlated with the market are concentrated in Finance (H), Services (I), and Transportation/Utilities (E). The highest co-movers include H88215 and H90000 (Finance), with correlations approaching 1.0, confirming that Finance stocks are the most representative of systematic risk. This is consistent with PCA and factor analysis findings below, where Finance and Services dominate the common factors, while Retail and Wholesale remain largely idiosyncratic.

# PCA

## Scree Plot and PC loadings
```{r scree, fig.cap="Scree plot of PCA"}
# Prepare data for PCA
stock_pca <- stock %>% 
  select(-Date) %>% 
  as.matrix()

stock_pca_std <- scale(stock_pca)

# PCA
pca <- prcomp(stock_pca_std, 
              center = FALSE, 
              scale. = FALSE)

screeplot(pca, type = "lines")
```
The scree plot shows that the first principal component (PC1) explains the largest share of the variance, reflecting broad market movements. PC2 and PC3 add meaningful but smaller contributions, after which the eigenvalues flatten, indicating diminishing returns. Following the elbow criterion, three principal components were retained, together explaining around 36% of the total variance in stock returns. This is consistent with expectations in financial data, where a small number of systematic factors explain market-wide risk, and the remainder reflects idiosyncratic noise.

## PCA Biplot
```{r}
loadings <- as.data.frame(pca$rotation[,1:3]) %>% 
  rownames_to_column("stock")

ggplot(loadings, aes(PC1, PC2, color = substr(stock,1,1))) +
  geom_point() +
  geom_text_repel(aes(label=stock), size=2) +
  theme_minimal() + 
 ggtitle("PCA Biplot")
```
The PCA biplot shows that PC1 captures the primary systematic market factor, with most stocks clustering along the negative PC1 axis. PC2 separates industries, particularly Finance/Insurance/Real Estate (H), which exhibit distinct variation beyond the market factor. Stocks such as H90000 and H88215 lie far along PC1, consistent with their high correlations with the market. Conversely, H77468 and H89500 exhibit strong PC2 loadings, indicating sector-specific dynamics. Industries E and I cluster closer to the PC1 axis, suggesting higher market dependence, while H contributes additional industry-specific variation.

## Industry centroids on PC1 and PC2
```{r pc12, fig.cap="Centroids of industries on PC1 & PC2"}
# Get PC1 and PC2 industry scores
load <- as.data.frame(pca$rotation[,1:3]) %>%
  rownames_to_column("stock")

load$industry <- substr(load$stock, 1, 1)

readr::write_csv(load, "Data/pca_loadings.csv")

industry_centroids <- load %>%
  group_by(industry) %>%
  summarise(PC1 = mean(PC1), 
            PC2 = mean(PC2),
            PC3 = mean(PC3))

# Plot centroids
ggplot(industry_centroids, 
       aes(PC1, PC2, color = industry)) +
  geom_point(size=4) +
  geom_text(aes(label = industry), hjust=-1, vjust=-0.5) +
  theme_minimal() +
  labs(title="Industry centroids on PC1 & PC2") + 
  guides(color = "none")
```

The industry centroids show that industry D (Manufacturing), G (Retail Trade) are high on PC1, industry H (Finance, Insurance and Real Estate), B (Mining) are high on PC2, and industry F (Wholesale Trade) is high on both, which is considered an outlier. Industry B (Mining) is very high on PC3. PC1 captures the largest portion of variance across all stock returns. In the context of financial data, this corresponds to the systematic risk, i.e., the component of returns that affects many stocks simultaneously and cannot be diversified away. As mentioned, industry E, H, and I are highly correlated with market return, and they all have a loading of around -0.11 for PC1, which is relatively negative compared to other industries. PC1 could then be considered slightly negatively correlated with market return, and details would be explored later. Since the PC2 are uncorrelated, industries with high importance to PC2 and PC3, industry F and B, could be considered to have unique industry variations (idiosyncratic risk).  

```{r}
scores <- as.data.frame(pca$x[, 1:3]) %>%
  cbind(Date = stock$Date, Market = market$MarketReturn)

# Standardize
scores_std <- scores %>%
  mutate(across(-Date, ~ as.numeric(scale(.))))

scores_long <- scores_std %>%
  pivot_longer(cols = c(PC1, PC2, PC3),
               names_to = "PC",
               values_to = "Score")

# Plot time series
ggplot(scores_long, aes(x = Date)) +
  geom_line(aes(y = Score)) +
  geom_line(aes(y = Market), color = "red", alpha = 0.6) +
  facet_wrap(~PC, ncol = 1, scales = "free_y") +
  theme_minimal() +
  labs(title = "PC1–PC3 vs Market Return (Standardized)",
       x = "Date", y = "Standardized Value",
       caption = "Red line = Market return") +
  theme(legend.position = "none")

pca_cor_labels <- scores_long %>%
  group_by(PC) %>%
  summarize(
    cor = cor(Market, Score, use = "complete.obs"),
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("cor = ", sprintf("%.2f", cor)),
    x = Inf,
    y = Inf
  )

ggplot(scores_long, aes(x = Market, y = Score)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm") +
  geom_text(data = pca_cor_labels, aes(x = x, y = y, label = label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE) +
  facet_wrap(~PC, ncol = 1, scales = "free_y") +
  theme_minimal() +
  labs(title = "Relationship between PC1–PC3 and market return",
       x = "Market Return", y = "PC Score")
```

The results from the PCA–market comparison clearly indicate that the first principal component (PC1) captures the dominant systematic market factor. The time series analysis shows that PC1 closely tracks the dynamics of the market return, moving almost in lockstep across the full sample period. This is further supported by the scatter plot, which reveals a very strong negative correlation (–0.95) between PC1 and market return. The negative sign is not economically meaningful, as PCA loadings are directionally arbitrary; instead, the magnitude of the correlation demonstrates that PC1 effectively represents the shared systematic risk across stocks. In contrast, the second and third principal components (PC2 and PC3) exhibit very weak correlations with the market (–0.11 and 0.01, respectively), suggesting that these dimensions reflect industry-specific or idiosyncratic effects rather than broad market co-movements. Overall, the analysis confirms that PC1 acts as a proxy for systematic risk, while higher-order components capture sectoral or stock-specific influences.

## Top 5 stocks most aligned with PC1 (systematic risk / market factor)

PC1 usually represents the market-wide factor. So, you’d pick stocks with the largest absolute loadings on PC1:
```{r}
# Extract PCA loadings for PC1
pc_load_tbl <- as.data.frame(pca$rotation[,1:3]) %>%
  rownames_to_column("stock") %>%
  mutate(
    industry = substr(stock, 1, 1),
    abs_PC1 = abs(PC1)   # absolute loadings for ranking
  ) %>%
  arrange(desc(abs_PC1))

# Top 5
top5_pc1 <- pc_load_tbl %>%
  slice_head(n = 5)

knitr::kable(top5_pc1, caption = "Top 5 Stocks by Absolute PC1 Loading")
```
These stocks are the most aligned with PC1 (systematic risk), so they move strongly with the overall market factor. Notice 4 of the 5 are Finance/Real Estate (H) → suggesting this industry drives much of the systematic co-movement in the sample.Including E77520 (Transportation/Utilities) adds some sector diversification. This makes them reasonable candidates for an investor who wants exposure to broad market movements.

## Factor Modelling

Building on these PCA results, we next turn to factor analysis to disentangle the structure of common versus idiosyncratic risk in greater detail. While PCA identifies PC1 as the dominant market-wide factor, factor models allow us to quantify how strongly each stock and industry loads on latent factors, and to evaluate the degree of uniqueness (idiosyncratic variation) that is not explained by systematic influences.

### Determine number of factors
```{r}
### Scree plot of eigenvalues
stock_only <- stock |> select(-Date)
X <- as.matrix(stock_only)
eig_vals <- eigen(cor(X))$values
eig_df <- data.frame(
  PC = 1:length(eig_vals),
  Eigenvalue = eig_vals
)

ggplot(eig_df, aes(x = PC, y = Eigenvalue)) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(
    title = "Scree Plot of Eigenvalues",
    x = "Principal Component",
    y = "Eigenvalue"
  )

```
The scree plot (see above) showed a steep decline in eigenvalues, with the elbow around 3 factors.

## Fit the Factor Model
```{r}
# Use correlation matrix eigenvalues for a quick factor count (Kaiser is liberal; cap at 5)

eig_vals <- eigen(cor(X))$values
kaiser_k <- sum(eig_vals > 1)
k <- min(3, kaiser_k)

# Fit factor model with easier convergence per assignment hint
fa <- factanal(X, factors = k, rotation = "promax",
               scores = "Bartlett", lower = 0.05)

print(fa, digits = 3, cutoff = 0.3)

# Industry-average loadings (Factor1..FactorK)
fa_load <- as_tibble(unclass(fa$loadings), rownames = "stock") %>%
  mutate(industry = substr(stock, 1, 1)) %>%
  group_by(industry) %>%
  summarise(across(starts_with("Factor"), ~ mean(.x, na.rm = TRUE)), .groups = "drop")

```




```{r}
#scree plot
fa_promax <- factanal(X, factors = k, rotation = "promax",
               scores = "Bartlett", lower = 0.05)

fa_promax_df <- tidy(fa_promax)

ggplot(fa_promax_df,aes(x=fl1,y=fl2, label=variable))+
geom_segment(aes(xend=fl1, yend=fl2,x=0,y=0),
arrow = arrow())+ geom_text(color='red',nudge_y = -0.05)




```

```{r}
fa_promax <- factanal(X, factors = k, rotation = "promax",
                      scores = "Bartlett", lower = 0.05)

fa_promax_df <- tidy(fa_promax)  # assumes columns: variable, fl1, fl2

ggplot(fa_promax_df, aes(x = fl1, y = fl2, label = variable)) +
  geom_segment(aes(x = 0, y = 0, xend = fl1, yend = fl2),
               arrow = arrow(length = unit(2, "mm")), linewidth = 0.2) +
  geom_point(size = 0) +
  geom_text_repel(
    max.overlaps = Inf,       # repel instead of dropping labels
    box.padding = 0.25,       # space around labels
    point.padding = 0.1,
    min.segment.length = 0,   # always draw leader lines if needed
    seed = 123,               # reproducible placement
    color = "red",            # keep your red labels
    size = 3
  ) +
  coord_equal() +
  expand_limits(x = c(-1.1, 1.1), y = c(-1.1, 1.1)) +
  theme_minimal()

```

# Table of both Factor model loading, uniqueness and PCA loadings
```{r}
library(tidyverse)

# 1. Factor Analysis loadings + uniqueness
fa_tbl <- as_tibble(unclass(fa$loadings), rownames = "stock") %>%
  rename(F1 = Factor1, F2 = Factor2, F3 = Factor3)

uniq_tbl <- tibble(stock = names(fa$uniquenesses),
                   uniqueness = as.numeric(fa$uniquenesses))

fa_tbl <- fa_tbl %>%
  left_join(uniq_tbl, by = "stock")

# 2. PCA loadings (rotation)
pc_tbl <- as.data.frame(pca$rotation[,1:3]) %>%
  rownames_to_column("stock") %>%
  rename(PC1 = PC1, PC2 = PC2, PC3 = PC3)

# 3. Combine both
rank_tbl <- fa_tbl %>%
  left_join(pc_tbl, by = "stock") %>%
  mutate(industry = substr(stock, 1, 1)) %>%
  arrange(uniqueness)

# 4. Preview top 10
rank_tbl %>%
  select(stock, industry, uniqueness, F1, F2, F3, PC1, PC2, PC3) %>%
  slice_head(n = 10)

```

Industry-level insight:

Industry H (Finance, Insurance & Real Estate) dominates Factor1 and Factor3, consistent with being the largest group (34% of stocks).

Industry E (Transportation & Utilities) shows moderate loadings across Factor2.

Industry B (Mining) stands out on PC3 (idiosyncratic variation).


The PCA results indicate that three principal components capture ~36% of total variance, with PC1 aligning broadly with systematic risk but showing a slightly negative correlation with the market return. Factor analysis with three factors explains ~31% of variance, with Factor1 strongly driven by Finance/Real Estate stocks (industry H), and Factor3 also linked to Finance but in different directions. Several H stocks (e.g., H90000, H89190) exhibit very low uniqueness and high factor loadings, indicating that their returns are predominantly explained by systematic risk. In contrast, stocks from industries such as Manufacturing (D) and Mining (B) tend to have high uniqueness, reflecting mostly idiosyncratic risk. This suggests that industry H carries the greatest systematic risk, while industries B and F contain more idiosyncratic variation. For an investor seeking market-representative stocks, low-uniqueness Finance/Real Estate stocks (such as H90000, H89190, H89437) would be recommended, whereas idiosyncratic Manufacturing and Mining stocks should be avoided in a systematic-risk-focused portfolio.




## Ranking criteria

- Low uniqueness = systematic (market-driven).

- Strong factor loading (absolute value, ≥0.8 is very strong).

- PC1 alignment = optional filter to ensure market co-movement.


## Recommended Top 5 Stocks
```{r}
# Get absolute strongest factor loading for each stock
df <- rank_tbl %>%
  rowwise() %>%
  mutate(max_loading = max(abs(c(F1, F2, F3)))) %>%
  ungroup()

# Mark top 5 recommended stocks
top5 <- c("H90000", "H88215", "H75157", "H89050", "H77466")
df <- df %>%
  mutate(top_pick = ifelse(stock %in% top5, "Yes", "No"))

# Plot
ggplot(df, aes(x = uniqueness, y = max_loading, color = top_pick, label = stock)) +
  geom_point(size = 3) +
  geom_text_repel(aes(label = ifelse(top_pick == "Yes", stock, "")),
                  size = 3, box.padding = 0.25, max.overlaps = Inf) +
  scale_color_manual(values = c("Yes" = "red", "No" = "grey")) +
  theme_minimal() +
  labs(title = "Uniqueness vs Strongest Factor Loading",
       subtitle = "Top 5 market-like stocks highlighted in red",
       x = "Uniqueness (idiosyncratic risk)",
       y = "Strongest Factor Loading (systematic risk)",
       color = "Top 5 Pick")

```


Based on lowest uniqueness and high factor loadings:

H90000 (Finance, uniqueness 0.05, F2 = 0.697)

H88215 (Finance, uniqueness 0.097, F1 = 0.569)

H75157 (Finance, uniqueness 0.219, F3 = 0.933)

H89050 (Finance, uniqueness 0.233, F3 = 0.923)

H77466 (Finance, uniqueness 0.251, F3 = 0.897)

From the factor analysis results, the five stocks most representative of systematic risk are H90000, H88215, H75157, H89050, and H77466, all from the Finance, Insurance & Real Estate sector. These stocks have low uniqueness values (0.05–0.25), indicating that their returns are largely explained by common factors. They also exhibit very high factor loadings (>0.55), confirming their alignment with market-wide systematic variation. These would be the most suitable candidates for an investor aiming to track market movements.

# References

```{r pca_summary, tbl.cap="Variance explained by PC1–PC3"}
var_explained <- pca$sdev^2
prop_var <- var_explained / sum(var_explained)
cum_var <- cumsum(prop_var)

# Combine into a table
pc_summary <- data.frame(
  PC = paste0("PC", 1:length(var_explained)),
  Variance = round(var_explained, 4),
  Proportion = round(prop_var, 4),
  Cumulative = round(cum_var, 4)
)

knitr::kable(pc_summary[1:3, ])
```

```{r pca_loading, tbl.cap="Loadings by Industry for PC1, PC2, PC3"}

knitr::kable(industry_centroids)
```