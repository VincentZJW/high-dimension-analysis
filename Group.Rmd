---
title: "Group"
output: 
  bookdown::html_document2
echo: FALSE
---

```{r, inlude=FALSE}
library(tidyverse)
library(visdat)
```

# Introduction
```{r}
# Load the data
stock <- read_csv("Data/SampleA.csv")
market <- read_csv("Data/Market.csv")
```

# IDA and EDA
### Check missing values and data types
```{r}
vis_miss(stock) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
vis_dat(stock) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

```{r}
# Transform to Date format
stock <- stock %>%
  mutate(
    year = str_extract(Date, "\\d{4}"),
    month = str_extract(Date, "(?<=M)\\d+"),
    month = str_pad(month, width = 2, pad = "0"),
    Date = paste0(year, "-", month),
    Date = as.Date(paste0(Date, "-01"))
  ) %>%
  select(-year, -month)

market <- market %>%
  mutate(
    year = str_extract(Date, "\\d{4}"),
    month = str_extract(Date, "(?<=M)\\d+"),
    month = str_pad(month, width = 2, pad = "0"),
    Date = paste0(year, "-", month),
    Date = as.Date(paste0(Date, "-01"))
  ) %>%
  select(-year, -month)
```

### Check for outliers using z-scores 

```{r}
# Compute z-scores for each stock
stock_z <- stock %>%
  mutate(across(-Date, ~ scale(.)[, 1], .names = "{.col}_z"))

stock_z_long <- stock_z %>%
  pivot_longer(
    cols = ends_with("_z"),
    names_to = "Stock_z",
    values_to = "Z_Score"
  ) %>%
  mutate(
    Stock = str_remove(Stock_z, "_z") 
  )

# Filter rows where abs(z-score) > 3 (3-sigma outliers)
outlier_df <- stock_z_long %>%
  filter(abs(Z_Score) > 3) %>%
  select(Date, Stock, Z_Score) %>%
  arrange(desc(abs(Z_Score)))

# join with raw returns
outlier_df <- outlier_df %>%
  left_join(stock %>% 
              pivot_longer(-Date, names_to = "Stock", values_to = "Return"),
            by = c("Date", "Stock"))

# View as tibble
top_outlier <- head(outlier_df,5)
```

```{r}
# Per-stock summary stats
long <- stock %>% 
  pivot_longer(-Date, names_to = "stock", values_to = "ret")
summ <- long %>%
  group_by(stock) %>%
  summarise(
    n = sum(!is.na(ret)),
    miss_rate = mean(is.na(ret)),
    mean = mean(ret, na.rm = TRUE),
    sd = sd(ret, na.rm = TRUE),
    min = min(ret, na.rm = TRUE),
    p25 = quantile(ret, 0.25, na.rm = TRUE),
    median = median(ret, na.rm = TRUE),
    p75 = quantile(ret, 0.75, na.rm = TRUE),
    max = max(ret, na.rm = TRUE),
    .groups = "drop"
  ) %>% arrange(desc(sd))
summ %>% slice_head(n = 12)
```

### Boxplot of top volatile stocks
```{r}
top9 <- summ %>% slice_max(sd, n = pmin(9, nrow(summ))) %>% pull(stock)
stock %>%
  select(Date, all_of(top9)) %>%
  pivot_longer(-Date, names_to = "stock", values_to = "ret") %>%
  ggplot(aes(stock, ret)) +
  geom_boxplot(outlier.alpha = 0.5) +
  coord_flip() +
  labs(title = "Return distributions — top9 volatile stock", x = NULL, y = "Monthly return") +
  theme_minimal()
```

### Time series of top volatile stocks
```{r}
stock %>%
  select(Date, all_of(top9)) %>%
  pivot_longer(-Date, names_to = "stock", values_to = "ret") %>%
  ggplot(aes(Date, ret)) +
  geom_line(linewidth = 0.3) +
  facet_wrap(~ stock, scales = "free_y") +
  labs(title = "Monthly returns over time — top9 volatile stock", x = NULL, y = "Return") +
  theme_minimal()
```

### Check duplicates
```{r}
#Check duplicate value
stock %>% filter(duplicated(.))
```

### Check for missing months
```{r}
# Check for missing months
seq_months <- tibble(Date = seq(min(stock$Date, na.rm = TRUE),
                                max(stock$Date, na.rm = TRUE),
                                by = "month"))
missing_months <- seq_months %>% 
  anti_join(stock %>% distinct(Date), by = "Date")
```

### Industry summary
```{r}
# Extract industry from stock names
stock_ind <- long %>%
  mutate(ind = str_extract(stock, "^[A-Za-z]+"))

# Summary by industry
industry_summary <- stock_ind %>%
  group_by(ind) %>%
  summarise(
    n_stocks = n_distinct(stock),
    mean_ret = mean(ret, na.rm=TRUE),
    sd_ret = sd(ret, na.rm=TRUE))
industry_summary

ggplot(stock_ind, aes(ind, ret)) + 
  geom_violin(trim=TRUE) + 
  coord_flip() +
  theme_minimal() +
  labs(title = "Return distributions by industry", 
       x = "Industry", 
       y = "Return")
```
# PCA

```{r, fig.cap="Scree plot of PCA"}
# Prepare data for PCA
stock_pca <- stock %>% 
  select(-Date) %>% 
  as.matrix()

stock_pca_std <- scale(stock_pca)

# PCA
pca <- prcomp(stock_pca_std, 
              center = FALSE, 
              scale. = FALSE)

screeplot(pca, type = "lines")
```



PCA is conducted after standardizing the data. 3 PCs are selected as the elbow point is at PC3 from the scree plot.  

```{r biplot, fig.cap="Biplot of PCA"}
# PCA biplot
biplot(pca)
```






# References
